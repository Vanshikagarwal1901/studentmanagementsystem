<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .login-container {
            max-width: 420px;
            margin: 80px auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .login-container h2 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease;
        }
        
        .hidden {
            display: none;
        }
        
        .dashboard h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #718096;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            background: #f7fafc;
            color: #667eea;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-content h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        th, td {
            padding: 16px;
            text-align: left;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        td {
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: #f7fafc;
            transform: scale(1.01);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .inline-row { 
            display: flex; 
            gap: 12px; 
        }
        
        .inline-row .form-group { 
            flex: 1; 
            margin-bottom: 0; 
        }
        
        @media (max-width:700px){ 
            .inline-row{ 
                flex-direction: column; 
            } 
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            padding: 12px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .logout-btn {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
        }
        
        .logout-btn:hover {
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }
        
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: #fff;
            display: none;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .message.success { 
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .message.error { 
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        .spinner-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }
        
        .spinner { 
            width: 60px; 
            height: 60px; 
            border: 6px solid #e2e8f0; 
            border-top-color: #667eea; 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .btn { 
            padding: 8px 16px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn.primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
        }
        
        .btn.danger { 
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white; 
        }
        
        .btn.small { 
            padding: 6px 12px; 
            font-size: 13px; 
        }
        
        table tbody tr td .btn { 
            margin-right: 8px; 
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            border-radius: 16px;
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }
        
        .stat-card.orange {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }
        
        .stat-card.red {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
        }
        
        .chart-container {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .chart-container h4 {
            color: #2d3748;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 24px 0;
        }
        
        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .search-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
        }
        
        .form-card {
            background: #f7fafc;
            padding: 24px;
            border-radius: 16px;
            margin: 20px 0;
            border: 2px solid #e2e8f0;
        }
        
        .form-card h4 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .top-performers-table tbody tr:nth-child(1) {
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
        }
        
        .top-performers-table tbody tr:nth-child(2) {
            background: linear-gradient(90deg, #c0c0c0 0%, #e8e8e8 100%);
        }
        
        .top-performers-table tbody tr:nth-child(3) {
            background: linear-gradient(90deg, #cd7f32 0%, #e8a87c 100%);
        }
        
        .grade-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .grade-a-plus { background: #48bb78; color: white; }
        .grade-a { background: #68d391; color: white; }
        .grade-b-plus { background: #4299e1; color: white; }
        .grade-b { background: #63b3ed; color: white; }
        .grade-c { background: #ed8936; color: white; }
        .grade-d { background: #fc8181; color: white; }
        .grade-f { background: #e53e3e; color: white; }
    </style>
</head>
<body>
    <div id="message" class="message" role="status"></div>
    <div id="spinner" class="spinner-overlay"><div class="spinner"></div></div>
    
    <!-- Login Section -->
    <div id="loginSection" class="container">
        <div class="login-container">
            <h2>üéì Student Management</h2>
            <div class="form-group">
                <label>Role:</label>
                <select id="roleSelect">
                    <option value="admin">Admin</option>
                    <option value="faculty">Faculty</option>
                </select>
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="username" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button onclick="login()">Login</button>
            <div id="loginMessage" style="margin-top: 15px; color: #e53e3e; text-align: center;"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="container hidden">
        <div class="dashboard">
            <h2>
                <span>Admin Dashboard</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card green">
                    <div class="stat-label">Total Faculty</div>
                    <div class="stat-value" id="summaryFacultyCount">0</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-value" id="summaryStudentsCount">0</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-label">Active Assignments</div>
                    <div class="stat-value" id="summaryAssignmentsCount">0</div>
                </div>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('facultyTab')">üë®‚Äçüè´ Faculty</button>
                <button class="tab-button" onclick="showTab('studentsTab')">üë®‚Äçüéì Students</button>
                <button class="tab-button" onclick="showTab('assignTab')">üìã Assignments</button>
            </div>

            <!-- Faculty Management Tab -->
            <div id="facultyTab" class="tab-content active">
                <h3>Faculty Management</h3>
                <div class="search-bar">
                    <button onclick="showAddFacultyForm()">‚ûï Add Faculty</button>
                    <input id="searchFacultyInput" type="search" placeholder="üîç Search faculty..." oninput="filterFaculty()" />
                </div>
                
                <div id="addFacultyForm" class="hidden form-card">
                    <h4>Add New Faculty</h4>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="facultyUsername" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="facultyPassword" placeholder="Password">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="facultyEmail" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="facultyFullName" placeholder="Full Name">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="facultyDepartment" placeholder="Department">
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="facultySubject" placeholder="Subject">
                    </div>
                    <button id="facultySaveBtn" onclick="addFaculty()">Save</button>
                    <button id="facultyCancelBtn" onclick="hideAddFacultyForm()" style="margin-left: 10px; background: #718096;">Cancel</button>
                </div>

                <table id="facultyTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Department</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Students Management Tab -->
            <div id="studentsTab" class="tab-content">
                <h3>Student Management</h3>
                <div class="search-bar">
                    <button onclick="showAddStudentForm()">‚ûï Add Student</button>
                    <input id="searchStudentsInput" type="search" placeholder="üîç Search students..." oninput="filterStudents()" />
                </div>
                
                <div id="addStudentForm" class="hidden form-card">
                    <h4>Add New Student</h4>
                    <div class="form-group">
                        <label>Roll Number</label>
                        <input type="text" id="studentRollNumber" placeholder="Roll Number">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="studentFullName" placeholder="Full Name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="studentEmail" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="studentPhone" placeholder="Phone">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="studentDepartment" placeholder="Department">
                    </div>
                    <div class="form-group">
                        <label>Semester</label>
                        <input type="number" id="studentSemester" placeholder="Semester">
                    </div>
                    <button id="studentSaveBtn" onclick="addStudent()">Save</button>
                    <button id="studentCancelBtn" onclick="hideAddStudentForm()" style="margin-left: 10px; background: #718096;">Cancel</button>
                </div>

                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Semester</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Assignment Tab -->
            <div id="assignTab" class="tab-content">
                <h3>Assign Students to Faculty</h3>
                <div class="form-card">
                    <div class="form-group">
                        <label>Select Faculty</label>
                        <select id="assignFacultySelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Select Student</label>
                        <select id="assignStudentSelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="assignSubject" placeholder="Subject">
                    </div>
                    <button onclick="assignStudent()">Assign Student</button>
                </div>
                
                <div class="search-bar" style="margin-top: 30px;">
                    <h3 style="margin: 0;">Current Assignments</h3>
                    <input id="searchAssignmentsInput" type="search" placeholder="üîç Search assignments..." oninput="filterAssignments()" />
                </div>
                
                <table id="assignmentsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Faculty</th>
                            <th>Student</th>
                            <th>Subject</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div class="charts-grid" style="margin-top: 40px;">
                    <div class="chart-container">
                        <h4>üìä Assignments per Faculty</h4>
                        <canvas id="assignmentsPerFacultyChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>üéì Students by Department</h4>
                        <canvas id="studentsByDeptChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Faculty Dashboard -->
    <div id="facultyDashboard" class="container hidden">
        <div class="dashboard">
            <h2>
                <span>Faculty Dashboard</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </h2>
            
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showFacultyTab('assignedStudentsTab')">üë®‚Äçüéì My Students</button>
                <button class="tab-button" onclick="showFacultyTab('marksTab')">üìù Manage Marks</button>
                <button class="tab-button" onclick="showFacultyTab('performanceTab')">üìä Analytics</button>
                <button class="tab-button" onclick="downloadExcelReport()">üì• Export Excel</button>
            </div>

            <!-- Assigned Students Tab -->
            <div id="assignedStudentsTab" class="tab-content active">
                <h3>My Assigned Students</h3>
                <table id="assignedStudentsTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Department</th>
                            <th>Semester</th>
                            <th>Subject</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Marks Management Tab -->
            <div id="marksTab" class="tab-content">
                <h3>Manage Student Marks</h3>
                <div class="form-card">
                    <div class="form-group">
                        <label>Select Student</label>
                        <select id="marksStudentSelect"></select>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="marksSubject" placeholder="Subject">
                    </div>
                    <div class="inline-row">
                        <div class="form-group">
                            <label>Theory (0-100)</label>
                            <input type="number" id="theoryMarks" placeholder="Theory" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Internal (0-20)</label>
                            <input type="number" id="internalMarks" placeholder="Internal" min="0" max="20">
                        </div>
                        <div class="form-group">
                            <label>Lab (0-30)</label>
                            <input type="number" id="labMarks" placeholder="Lab" min="0" max="30">
                        </div>
                        <div class="form-group">
                            <label>Assignment (0-50)</label>
                            <input type="number" id="assignmentMarks" placeholder="Assignment" min="0" max="50">
                        </div>
                    </div>
                    <div class="inline-row" style="margin-top:12px;">
                        <div class="form-group">
                            <label>Semester</label>
                            <input type="number" id="semester" placeholder="Semester">
                        </div>
                        <div class="form-group">
                            <label>Academic Year</label>
                            <input type="number" id="academicYear" placeholder="Academic Year" value="2024">
                        </div>
                    </div>
                    <button onclick="updateMarks()" style="margin-top:12px;">Update Marks</button>
                </div>

                <h3 style="margin-top: 40px;">Current Marks</h3>
                <table id="marksTable">
                    <thead>
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Subject</th>
                            <th>Theory</th>
                            <th>Internal</th>
                            <th>Lab</th>
                            <th>Assignment</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Performance Analytics Tab -->
            <div id="performanceTab" class="tab-content">
                <h3>üìä Student Performance Analytics</h3>
                
                <div class="stats-grid">
                    <div class="stat-card green">
                        <div class="stat-label">Average Score</div>
                        <div class="stat-value" id="avgScore">--</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-label">Total Students</div>
                        <div class="stat-value" id="totalStudents">--</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Subjects Taught</div>
                        <div class="stat-value" id="subjectCount">--</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Below 50%</div>
                        <div class="stat-value" id="failingCount">--</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>üèÜ Top Student Performance</h4>
                        <canvas id="performanceBarChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>üìà Grade Distribution</h4>
                        <canvas id="gradeDistChart"></canvas>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>üìö Subject-wise Average</h4>
                        <canvas id="subjectAvgChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>üìä Performance Distribution</h4>
                        <canvas id="performanceDistChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" style="margin-top: 30px;">
                    <h4>üèÖ Top 10 Performers</h4>
                    <table id="topPerformersTable" class="top-performers-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Roll No</th>
                                <th>Student Name</th>
                                <th>Subject</th>
                                <th>Total Marks</th>
                                <th>Percentage</th>
                                <th>Grade</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
const API_BASE = 'http://localhost:5000/api';
let currentUser = null;
let token = null;

function showElement(id) { const el = document.getElementById(id); if (el) el.classList.remove('hidden'); }
function hideElement(id) { const el = document.getElementById(id); if (el) el.classList.add('hidden'); }
function safeAddActive(el) { if (el) el.classList.add('active'); }

function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
  const tab = document.getElementById(tabId);
  if (tab) tab.classList.add('active');
  if (event && event.target) safeAddActive(event.target);
}

function showFacultyTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
  const tab = document.getElementById(tabId);
  if (tab) tab.classList.add('active');
  if (event && event.target) safeAddActive(event.target);
  if (tabId === 'performanceTab') {
    loadPerformanceAnalytics();
  }
}

async function login() {
  const role = document.getElementById('roleSelect').value;
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  try {
    const resp = await fetch(`${API_BASE}/${role}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
    const data = await resp.json();
    if (resp.ok) {
      token = data.token; currentUser = data.user;
      localStorage.setItem('token', token); localStorage.setItem('user', JSON.stringify(currentUser));
      hideElement('loginSection');
      if (currentUser.role === 'admin') { showElement('adminDashboard'); loadAdminData(); } else { showElement('facultyDashboard'); loadFacultyData(); }
    } else document.getElementById('loginMessage').textContent = data.error;
  } catch (e) { document.getElementById('loginMessage').textContent = 'Login failed: ' + e.message; }
}

function logout() { token = null; currentUser = null; localStorage.removeItem('token'); localStorage.removeItem('user'); hideElement('adminDashboard'); hideElement('facultyDashboard'); showElement('loginSection'); }

function checkAuth() { const t = localStorage.getItem('token'); const u = localStorage.getItem('user'); if (t && u) { token = t; currentUser = JSON.parse(u); hideElement('loginSection'); if (currentUser.role === 'admin') { showElement('adminDashboard'); loadAdminData(); } else { showElement('facultyDashboard'); loadFacultyData(); } } }

async function apiCall(endpoint, options = {}) { if (!token) { logout(); return; } const defaultOptions = { headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } }; const resp = await fetch(`${API_BASE}${endpoint}`, { ...defaultOptions, ...options }); if (resp.status === 401) { logout(); throw new Error('Session expired'); } return resp; }

function showMessage(text, type='success', timeout=3000){
  const el = document.getElementById('message');
  if (!el) { console.log(text); return; }
  el.textContent = text; el.className = `message ${type}`; el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, timeout);
}

function showLoading(on=true){ const s = document.getElementById('spinner'); if (!s) return; s.style.display = on ? 'flex' : 'none'; }

async function loadAdminData() { await loadFaculty(); await loadStudents(); await loadAssignmentData(); }

async function renderAdminSummary() {
  try {
    const [fR, sR, aR] = await Promise.all([apiCall('/admin/faculty'), apiCall('/admin/students'), apiCall('/admin/assignments')]);
    const [faculties, students, assignments] = await Promise.all([fR.json(), sR.json(), aR.json()]);
    const fCountEl = document.getElementById('summaryFacultyCount'); if (fCountEl) fCountEl.textContent = (faculties && faculties.length) ? faculties.length : 0;
    const sCountEl = document.getElementById('summaryStudentsCount'); if (sCountEl) sCountEl.textContent = (students && students.length) ? students.length : 0;
    const aCountEl = document.getElementById('summaryAssignmentsCount'); if (aCountEl) aCountEl.textContent = (assignments && assignments.length) ? assignments.length : 0;
  } catch (e) { console.error('Error rendering admin summary', e); }
}

async function loadFaculty() {
  try {
    const r = await apiCall('/admin/faculty');
    const faculty = await r.json();
    const tbody = document.querySelector('#facultyTable tbody');
    tbody.innerHTML = faculty.map(f => `
      <tr>
        <td>${f.faculty_id}</td>
        <td>${f.username}</td>
        <td>${f.full_name}</td>
        <td>${f.department}</td>
        <td>${f.subject}</td>
        <td><span style="color: ${f.is_active ? '#48bb78' : '#e53e3e'}; font-weight: 600;">${f.is_active ? '‚úì Active' : '‚úó Inactive'}</span></td>
        <td>
          <button class="btn primary small" onclick="startEditFaculty(${f.faculty_id})">Edit</button>
          <button class="btn danger small" onclick="deleteFaculty(${f.faculty_id})">Delete</button>
        </td>
      </tr>
    `).join('');
    renderAdminSummary();
  } catch (e) { console.error('Error loading faculty', e); }
}

let editingFacultyId = null;
async function startEditFaculty(id) {
  try {
    const r = await apiCall(`/admin/faculty/${id}`);
    if (!r.ok) { showMessage('Failed to fetch faculty', 'error'); return; }
    const f = await r.json();
    document.getElementById('facultyUsername').value = f.username || '';
    document.getElementById('facultyPassword').value = f.password || '';
    document.getElementById('facultyEmail').value = f.email || '';
    document.getElementById('facultyFullName').value = f.full_name || '';
    document.getElementById('facultyDepartment').value = f.department || '';
    document.getElementById('facultySubject').value = f.subject || '';
    showElement('addFacultyForm');
    document.querySelector('#addFacultyForm h4').textContent = 'Edit Faculty';
    document.getElementById('facultySaveBtn').textContent = 'Save';
    editingFacultyId = id;
  } catch (e) { showMessage('Error: ' + e.message, 'error'); }
}

async function deleteFaculty(id) {
  if (!confirm('Delete this faculty and all related assignments/marks?')) return;
  try {
    showLoading(true);
    const r = await apiCall(`/admin/faculty/${id}`, { method: 'DELETE' });
    if (r.ok) {
      showMessage('Faculty deleted');
      loadFaculty();
      loadAssignmentData();
    } else {
      const e = await r.json();
      showMessage('Error: ' + e.error, 'error');
    }
  } catch (e) {
    showMessage('Error: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function addFaculty() {
  const data = { 
    username: document.getElementById('facultyUsername').value, 
    password: document.getElementById('facultyPassword').value, 
    email: document.getElementById('facultyEmail').value, 
    full_name: document.getElementById('facultyFullName').value, 
    department: document.getElementById('facultyDepartment').value, 
    subject: document.getElementById('facultySubject').value,
    is_active: 1  // Always set active when adding/editing
  };
  try {
    showLoading(true);
    if (editingFacultyId) {
      const r = await apiCall(`/admin/faculty/${editingFacultyId}`, { method: 'PUT', body: JSON.stringify(data) });
      if (r.ok) {
        showMessage('Faculty updated');
        editingFacultyId = null;
        document.querySelector('#addFacultyForm h4').textContent = 'Add New Faculty';
        document.getElementById('facultySaveBtn').textContent = 'Add Faculty';
        hideAddFacultyForm();
        loadFaculty();
      } else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
    } else {
      const r = await apiCall('/admin/faculty', { method: 'POST', body: JSON.stringify(data) });
      if (r.ok) { showMessage('Faculty added'); hideAddFacultyForm(); loadFaculty(); } else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
    }
  } catch (e) { showMessage('Error: ' + e.message, 'error'); }
  finally { showLoading(false); }
}

function showAddFacultyForm() { showElement('addFacultyForm'); }
function hideAddFacultyForm() { editingFacultyId = null; document.querySelector('#addFacultyForm h4').textContent = 'Add New Faculty'; document.getElementById('facultySaveBtn').textContent = 'Add Faculty'; hideElement('addFacultyForm'); }

async function loadStudents() {
  try {
    const r = await apiCall('/admin/students');
    const students = await r.json();
    const tbody = document.querySelector('#studentsTable tbody');
    tbody.innerHTML = students.map(s => `
      <tr>
        <td>${s.roll_number}</td>
        <td>${s.full_name}</td>
        <td>${s.email}</td>
        <td>${s.department}</td>
        <td>${s.semester}</td>
        <td><span style="color: ${s.is_active ? '#48bb78' : '#e53e3e'}; font-weight: 600;">${s.is_active ? '‚úì Active' : '‚úó Inactive'}</span></td>
        <td>
          <button class="btn primary small" onclick="startEditStudent(${s.student_id})">Edit</button>
          <button class="btn danger small" onclick="deleteStudent(${s.student_id})">Delete</button>
        </td>
      </tr>
    `).join('');
    renderAdminSummary();
  } catch (e) { console.error('Error loading students', e); }
}

let editingStudentId = null;
async function startEditStudent(id) {
  try {
    const r = await apiCall(`/admin/students/${id}`);
    if (!r.ok) { showMessage('Failed to fetch student', 'error'); return; }
    const s = await r.json();
    document.getElementById('studentRollNumber').value = s.roll_number || '';
    document.getElementById('studentFullName').value = s.full_name || '';
    document.getElementById('studentEmail').value = s.email || '';
    document.getElementById('studentPhone').value = s.phone || '';
    document.getElementById('studentDepartment').value = s.department || '';
    document.getElementById('studentSemester').value = s.semester || '';
    showElement('addStudentForm');
    document.querySelector('#addStudentForm h4').textContent = 'Edit Student';
    document.getElementById('studentSaveBtn').textContent = 'Save';
    editingStudentId = id;
  } catch (e) { showMessage('Error: ' + e.message, 'error'); }
}

async function deleteStudent(id) {
  if (!confirm('Delete this student and all related assignments/marks?')) return;
  try {
    showLoading(true);
    const r = await apiCall(`/admin/students/${id}`, { method: 'DELETE' });
    if (r.ok) {
      showMessage('Student deleted');
      loadStudents();
      loadAssignmentData();
    } else {
      const e = await r.json();
      showMessage('Error: ' + e.error, 'error');
    }
  } catch (e) {
    showMessage('Error: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function addStudent() {
  const data = { 
    roll_number: document.getElementById('studentRollNumber').value, 
    full_name: document.getElementById('studentFullName').value, 
    email: document.getElementById('studentEmail').value, 
    phone: document.getElementById('studentPhone').value, 
    department: document.getElementById('studentDepartment').value, 
    semester: parseInt(document.getElementById('studentSemester').value),
    is_active: 1  // Always set active when adding/editing
  };
  try {
    showLoading(true);
    if (editingStudentId) {
      const r = await apiCall(`/admin/students/${editingStudentId}`, { method: 'PUT', body: JSON.stringify(data) });
      if (r.ok) {
        showMessage('Student updated');
        editingStudentId = null;
        document.querySelector('#addStudentForm h4').textContent = 'Add New Student';
        document.getElementById('studentSaveBtn').textContent = 'Add Student';
        hideAddStudentForm();
        loadStudents();
      } else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
    } else {
      const r = await apiCall('/admin/students', { method: 'POST', body: JSON.stringify(data) });
      if (r.ok) { showMessage('Student added'); hideAddStudentForm(); loadStudents(); } else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
    }
  } catch (e) { showMessage('Error: ' + e.message, 'error'); }
  finally { showLoading(false); }
}

function showAddStudentForm() { showElement('addStudentForm'); }
function hideAddStudentForm() { editingStudentId = null; document.querySelector('#addStudentForm h4').textContent = 'Add New Student'; document.getElementById('studentSaveBtn').textContent = 'Add Student'; hideElement('addStudentForm'); }

let _cachedFaculty = [];
let _cachedStudents = [];
let _cachedAssignments = [];

function renderAssignmentsTable(assignments = [], faculty = [], students = []){
  _cachedAssignments = assignments;
  _cachedFaculty = faculty;
  _cachedStudents = students;
  const facultyById = Object.fromEntries((faculty||[]).map(f => [f.faculty_id, f]));
  const studentById = Object.fromEntries((students||[]).map(s => [s.student_id, s]));
  const tbody = document.querySelector('#assignmentsTable tbody');
  if (!tbody) return;
  tbody.innerHTML = (assignments||[]).map(a => {
    const f = facultyById[a.faculty_id];
    const s = studentById[a.student_id];
    const fname = f ? (f.full_name || `Faculty ${f.faculty_id}`) : a.faculty_id;
    const sname = s ? (s.full_name || `Student ${s.student_id}`) : a.student_id;
    return `<tr data-id="${a.assignment_id}">
      <td>${a.assignment_id}</td>
      <td class="assign-faculty">${escapeHtml(fname)}</td>
      <td class="assign-student">${escapeHtml(sname)}</td>
      <td class="assign-subject">${escapeHtml(a.subject || '')}</td>
      <td><button class="btn danger small" onclick="deleteAssignment(${a.assignment_id})">Delete</button></td>
    </tr>`;
  }).join('');
}

function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

async function loadAssignmentData() {
  try {
    const [fR, sR] = await Promise.all([apiCall('/admin/faculty'), apiCall('/admin/students')]);
    const faculty = await fR.json(); const students = await sR.json();
    document.getElementById('assignFacultySelect').innerHTML = faculty.map(f => `<option value="${f.faculty_id}">${f.full_name} - ${f.subject}</option>`).join('');
    document.getElementById('assignStudentSelect').innerHTML = students.map(s => `<option value="${s.student_id}">${s.roll_number} - ${s.full_name}</option>`).join('');
    const asR = await apiCall('/admin/assignments'); const assignments = await asR.json();
    renderAdminSummary();
    renderAssignmentsTable(assignments, faculty, students);
    try { renderAssignmentsCharts(assignments, students, faculty); } catch (e) { console.error('Error rendering charts', e); }
  } catch (e) { console.error('Error loading assignments', e); }
}

function filterFaculty(){
  const q = (document.getElementById('searchFacultyInput').value || '').toLowerCase();
  const rows = document.querySelectorAll('#facultyTable tbody tr');
  rows.forEach(r => { r.style.display = (r.textContent || '').toLowerCase().includes(q) ? '' : 'none'; });
}

function filterStudents(){
  const q = (document.getElementById('searchStudentsInput').value || '').toLowerCase();
  const rows = document.querySelectorAll('#studentsTable tbody tr');
  rows.forEach(r => { r.style.display = (r.textContent || '').toLowerCase().includes(q) ? '' : 'none'; });
}

function filterAssignments(){
  const q = (document.getElementById('searchAssignmentsInput').value || '').toLowerCase();
  const rows = document.querySelectorAll('#assignmentsTable tbody tr');
  rows.forEach(r => { r.style.display = (r.textContent || '').toLowerCase().includes(q) ? '' : 'none'; });
}

let _assignmentsPerFacultyChart = null;
let _studentsByDeptChart = null;

function renderAssignmentsCharts(assignments = [], students = [], faculty = []) {
  const facultyName = {};
  (faculty || []).forEach(f => { facultyName[f.faculty_id] = f.full_name ? `${f.full_name}` : `Faculty ${f.faculty_id}`; });

  const facultyCount = {};
  assignments.forEach(a => { const id = a.faculty_id || 'unknown'; facultyCount[id] = (facultyCount[id] || 0) + 1; });

  const entries = Object.keys(facultyCount).map(id => ({ id, name: facultyName[id] || `ID ${id}`, count: facultyCount[id] }));
  entries.sort((a,b) => b.count - a.count);

  const labels = entries.map(e => e.name);
  const data = entries.map(e => e.count);

  const baseColors = ['#667eea','#764ba2','#48bb78','#4299e1','#ed8936','#f56565','#9f7aea'];
  const backgroundColors = labels.map((_,i) => baseColors[i % baseColors.length]);

  if (_assignmentsPerFacultyChart) { try { _assignmentsPerFacultyChart.destroy(); } catch(e){} _assignmentsPerFacultyChart = null; }
  const ctx1 = document.getElementById('assignmentsPerFacultyChart');
  if (ctx1) {
    const maxValue = (data && data.length) ? Math.max(...data) : 0;
    const suggestedMax = Math.max(maxValue + 1, 5);

    _assignmentsPerFacultyChart = new Chart(ctx1.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Assignments', data, backgroundColor: backgroundColors, borderRadius: 8 }] },
      options: {
        indexAxis: 'x',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ` ${ctx.formattedValue} assignment${ctx.formattedValue === '1' ? '' : 's'}` } }
        },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, suggestedMax: suggestedMax, grid: { color: '#e2e8f0' } }
        }
      }
    });
  }

  const deptCount = {};
  students.forEach(s => { const d = s.department || 'Unknown'; deptCount[d] = (deptCount[d] || 0) + 1; });
  const deptEntries = Object.keys(deptCount).map(k => ({ k, v: deptCount[k] }));
  const deptLabels = deptEntries.map(e => e.k);
  const deptData = deptEntries.map(e => e.v);
  const deptColors = deptLabels.map((_,i) => baseColors[i % baseColors.length]);

  if (_studentsByDeptChart) { try { _studentsByDeptChart.destroy(); } catch(e){} _studentsByDeptChart = null; }
  const ctx2 = document.getElementById('studentsByDeptChart');
  if (ctx2) {
    _studentsByDeptChart = new Chart(ctx2.getContext('2d'), {
      type: 'doughnut',
      data: { labels: deptLabels, datasets: [{ data: deptData, backgroundColor: deptColors }] },
      options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'right' } } }
    });
  }
}

async function assignStudent() {
  const faculty_id = document.getElementById('assignFacultySelect').value;
  const student_id = document.getElementById('assignStudentSelect').value;
  const subject = document.getElementById('assignSubject').value;
  try {
    showLoading(true);
    const r = await apiCall('/admin/assign-student', { method: 'POST', body: JSON.stringify({ faculty_id, student_id, subject }) });
    if (r.ok) {
      showMessage('Assigned');
      document.getElementById('assignSubject').value = '';
      loadAssignmentData();
    } else {
      const e = await r.json();
      showMessage('Error: ' + e.error, 'error');
    }
  } catch (e) {
    showMessage('Error: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

async function deleteAssignment(id) {
  if (!confirm('Delete assignment?')) return;
  try {
    showLoading(true);
    const r = await apiCall(`/admin/assignments/${id}`, { method: 'DELETE' });
    if (r.ok) { showMessage('Deleted'); loadAssignmentData(); }
    else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
  } catch (e) { showMessage('Error: ' + e.message, 'error'); } finally { showLoading(false); }
}

async function loadFacultyData() { await loadAssignedStudents(); await loadMarks(); await loadMarksStudents(); }

async function loadAssignedStudents() { 
  try { 
    const r = await apiCall('/faculty/students'); 
    const students = await r.json(); 
    document.querySelector('#assignedStudentsTable tbody').innerHTML = students.map(s => `
      <tr>
        <td>${s.roll_number}</td>
        <td>${s.student_name}</td>
        <td>${s.department}</td>
        <td>${s.semester}</td>
        <td>${s.subject}</td>
      </tr>
    `).join(''); 
  } catch (e) { console.error(e); } 
}

async function loadMarks() {
  try {
    const r = await apiCall('/faculty/marks');
    const marks = await r.json();
    const tbody = document.querySelector('#marksTable tbody');
    if (tbody) tbody.innerHTML = marks.map(m => `
      <tr>
        <td>${m.roll_number}</td>
        <td>${m.student_name}</td>
        <td>${m.subject}</td>
        <td>${m.theory_marks}</td>
        <td>${m.internal_marks}</td>
        <td>${m.lab_marks}</td>
        <td>${m.assignment_marks}</td>
        <td><strong>${m.total_marks}</strong></td>
        <td><button class="btn danger small" onclick="deleteMarks(${m.mark_id || 0})">Delete</button></td>
      </tr>
    `).join('');
  } catch (e) { console.error(e); }
}

async function deleteMarks(id) {
  if (!id || id === 0) { showMessage('Invalid mark id', 'error'); return; }
  if (!confirm('Delete marks?')) return;
  try {
    showLoading(true);
    const r = await apiCall(`/faculty/marks/${id}`, { method: 'DELETE' });
    if (r.ok) { showMessage('Deleted'); loadMarks(); }
    else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
  } catch (e) { showMessage('Error: ' + e.message, 'error'); }
  finally { showLoading(false); }
}

async function loadMarksStudents() { 
  try { 
    const r = await apiCall('/faculty/students'); 
    const students = await r.json(); 
    document.getElementById('marksStudentSelect').innerHTML = students.map(s => `<option value="${s.student_id}">${s.roll_number} - ${s.student_name} (${s.subject})</option>`).join(''); 
  } catch (e) { console.error(e); } 
}

async function updateMarks() {
  const student_id = document.getElementById('marksStudentSelect').value;
  const subject = document.getElementById('marksSubject').value;
  const theory_marks = parseFloat(document.getElementById('theoryMarks').value) || 0;
  const internal_marks = parseFloat(document.getElementById('internalMarks').value) || 0;
  const lab_marks = parseFloat(document.getElementById('labMarks').value) || 0;
  const assignment_marks = parseFloat(document.getElementById('assignmentMarks').value) || 0;
  const semester = parseInt(document.getElementById('semester').value);
  const academic_year = parseInt(document.getElementById('academicYear').value);
  try {
    showLoading(true);
    const r = await apiCall('/faculty/marks', { method: 'POST', body: JSON.stringify({ student_id, subject, theory_marks, internal_marks, lab_marks, assignment_marks, semester, academic_year }) });
    if (r.ok) {
      showMessage('Marks updated');
      loadMarks();
      document.getElementById('theoryMarks').value='';
      document.getElementById('internalMarks').value='';
      document.getElementById('labMarks').value='';
      document.getElementById('assignmentMarks').value='';
      document.getElementById('semester').value='';
    } else { const e = await r.json(); showMessage('Error: ' + e.error, 'error'); }
  } catch (e) { showMessage('Error: ' + e.message, 'error'); }
  finally { showLoading(false); }
}

async function downloadExcelReport() { 
  try { 
    const r = await fetch(`${API_BASE}/faculty/report/excel`, { headers: { 'Authorization': `Bearer ${token}` } }); 
    if (r.ok) { 
      const blob = await r.blob(); 
      const url = window.URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `marks_report_${currentUser.id}.xlsx`; 
      document.body.appendChild(a); 
      a.click(); 
      window.URL.revokeObjectURL(url); 
      document.body.removeChild(a); 
      showMessage('Report downloaded');
    } else showMessage('Error downloading report', 'error'); 
  } catch (e) { showMessage('Error: ' + e.message, 'error'); } 
}

let performanceCharts = {
  bar: null,
  grade: null,
  subject: null,
  distribution: null
};

function getGrade(percentage) {
  if (percentage >= 90) return 'A+';
  if (percentage >= 80) return 'A';
  if (percentage >= 70) return 'B+';
  if (percentage >= 60) return 'B';
  if (percentage >= 50) return 'C';
  if (percentage >= 40) return 'D';
  return 'F';
}

function getGradeClass(grade) {
  const map = { 'A+': 'grade-a-plus', 'A': 'grade-a', 'B+': 'grade-b-plus', 'B': 'grade-b', 'C': 'grade-c', 'D': 'grade-d', 'F': 'grade-f' };
  return map[grade] || 'grade-f';
}

async function loadPerformanceAnalytics() {
  try {
    showLoading(true);
    const r = await apiCall('/faculty/marks');
    const marks = await r.json();
    
    if (!marks || marks.length === 0) {
      showMessage('No marks data available', 'error');
      document.getElementById('avgScore').textContent = '0%';
      document.getElementById('totalStudents').textContent = '0';
      document.getElementById('subjectCount').textContent = '0';
      document.getElementById('failingCount').textContent = '0';
      return;
    }

    const maxMarks = 200;
    let totalScore = 0;
    let belowFiftyCount = 0;
    const subjectScores = {};
    const gradeCount = { 'A+': 0, 'A': 0, 'B+': 0, 'B': 0, 'C': 0, 'D': 0, 'F': 0 };
    
    const studentsMap = new Map();
    
    marks.forEach(m => {
      const total = m.total_marks || 0;
      const percentage = (total / maxMarks) * 100;
      totalScore += percentage;
      
      if (percentage < 50) belowFiftyCount++;
      
      const grade = getGrade(percentage);
      gradeCount[grade]++;
      
      if (!subjectScores[m.subject]) {
        subjectScores[m.subject] = { total: 0, count: 0 };
      }
      subjectScores[m.subject].total += percentage;
      subjectScores[m.subject].count++;
      
      const key = `${m.student_id}-${m.subject}`;
      studentsMap.set(key, {
        roll_number: m.roll_number,
        student_name: m.student_name,
        subject: m.subject,
        total_marks: total,
        percentage: percentage.toFixed(2),
        grade: grade
      });
    });
    
    const avgScore = marks.length > 0 ? (totalScore / marks.length).toFixed(2) : 0;
    const uniqueSubjects = Object.keys(subjectScores).length;
    
    document.getElementById('avgScore').textContent = avgScore + '%';
    document.getElementById('totalStudents').textContent = studentsMap.size;
    document.getElementById('subjectCount').textContent = uniqueSubjects;
    document.getElementById('failingCount').textContent = belowFiftyCount;
    
    renderPerformanceCharts(marks, subjectScores, gradeCount, studentsMap, maxMarks);
    
  } catch (e) {
    console.error('Error loading performance analytics', e);
    showMessage('Error: ' + e.message, 'error');
  } finally {
    showLoading(false);
  }
}

function renderPerformanceCharts(marks, subjectScores, gradeCount, studentsMap, maxMarks) {
  Object.keys(performanceCharts).forEach(key => {
    if (performanceCharts[key]) {
      try { performanceCharts[key].destroy(); } catch(e){}
      performanceCharts[key] = null;
    }
  });
  
  const colors = {
    primary: '#667eea',
    secondary: '#764ba2',
    success: '#48bb78',
    warning: '#ed8936',
    danger: '#f56565',
    info: '#4299e1',
    purple: '#9f7aea',
    teal: '#38b2ac'
  };
  
  // 1. Student Performance Bar Chart
  const ctx1 = document.getElementById('performanceBarChart');
  if (ctx1) {
    const studentData = Array.from(studentsMap.values())
      .sort((a, b) => b.percentage - a.percentage)
      .slice(0, 12);
    
    performanceCharts.bar = new Chart(ctx1.getContext('2d'), {
      type: 'bar',
      data: {
        labels: studentData.map(s => s.roll_number),
        datasets: [{
          label: 'Percentage',
          data: studentData.map(s => parseFloat(s.percentage)),
          backgroundColor: studentData.map(s => {
            const p = parseFloat(s.percentage);
            if (p >= 80) return colors.success;
            if (p >= 60) return colors.info;
            if (p >= 50) return colors.warning;
            return colors.danger;
          }),
          borderRadius: 8,
          barThickness: 40
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: {
              title: (items) => {
                const idx = items[0].dataIndex;
                return studentData[idx].student_name;
              },
              label: (context) => ` Score: ${context.formattedValue}%`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: { color: '#e2e8f0' },
            ticks: { 
              callback: value => value + '%',
              color: '#4a5568'
            }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#4a5568' }
          }
        }
      }
    });
  }
  
  // 2. Grade Distribution Doughnut Chart
  const ctx2 = document.getElementById('gradeDistChart');
  if (ctx2) {
    const gradeLabels = Object.keys(gradeCount).filter(g => gradeCount[g] > 0);
    const gradeValues = gradeLabels.map(g => gradeCount[g]);
    
    performanceCharts.grade = new Chart(ctx2.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: gradeLabels,
        datasets: [{
          data: gradeValues,
          backgroundColor: [
            colors.success, '#68d391', colors.info, '#63b3ed', 
            colors.warning, colors.danger, '#999'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { 
            position: 'right',
            labels: {
              padding: 15,
              font: { size: 13 },
              color: '#4a5568'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: {
              label: (context) => {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} students (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
  
  // 3. Subject-wise Average Scores
  const ctx3 = document.getElementById('subjectAvgChart');
  if (ctx3) {
    const subjectLabels = Object.keys(subjectScores);
    const subjectAvgs = subjectLabels.map(s => 
      (subjectScores[s].total / subjectScores[s].count).toFixed(2)
    );
    
    performanceCharts.subject = new Chart(ctx3.getContext('2d'), {
      type: 'bar',
      data: {
        labels: subjectLabels,
        datasets: [{
          label: 'Average %',
          data: subjectAvgs,
          backgroundColor: colors.primary,
          borderRadius: 8,
          barThickness: 50
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            max: 100,
            grid: { color: '#e2e8f0' },
            ticks: { 
              callback: value => value + '%',
              color: '#4a5568'
            }
          },
          y: {
            grid: { display: false },
            ticks: { color: '#4a5568' }
          }
        }
      }
    });
  }
  
  // 4. Performance Distribution Chart (Score Ranges)
  const ctx4 = document.getElementById('performanceDistChart');
  if (ctx4) {
    // Group students by score ranges
    const ranges = {
      '90-100%': 0,
      '80-89%': 0,
      '70-79%': 0,
      '60-69%': 0,
      '50-59%': 0,
      '40-49%': 0,
      'Below 40%': 0
    };
    
    Array.from(studentsMap.values()).forEach(s => {
      const p = parseFloat(s.percentage);
      if (p >= 90) ranges['90-100%']++;
      else if (p >= 80) ranges['80-89%']++;
      else if (p >= 70) ranges['70-79%']++;
      else if (p >= 60) ranges['60-69%']++;
      else if (p >= 50) ranges['50-59%']++;
      else if (p >= 40) ranges['40-49%']++;
      else ranges['Below 40%']++;
    });
    
    performanceCharts.distribution = new Chart(ctx4.getContext('2d'), {
      type: 'bar',
      data: {
        labels: Object.keys(ranges),
        datasets: [{
          label: 'Number of Students',
          data: Object.values(ranges),
          backgroundColor: [
            '#48bb78', // 90-100 - Green
            '#68d391', // 80-89 - Light Green
            '#4299e1', // 70-79 - Blue
            '#63b3ed', // 60-69 - Light Blue
            '#ed8936', // 50-59 - Orange
            '#fc8181', // 40-49 - Light Red
            '#e53e3e'  // Below 40 - Red
          ],
          borderRadius: 8,
          barThickness: 50
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12,
            callbacks: {
              label: (context) => ` ${context.formattedValue} student${context.formattedValue === 1 ? '' : 's'}`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { 
              stepSize: 1,
              color: '#4a5568'
            },
            grid: { color: '#e2e8f0' },
            title: { 
              display: true, 
              text: 'Number of Students',
              color: '#4a5568',
              font: { weight: 'bold' }
            }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#4a5568' },
            title: { 
              display: true, 
              text: 'Score Range',
              color: '#4a5568',
              font: { weight: 'bold' }
            }
          }
        }
      }
    });
  }
  
  // Top Performers Table
  const tbody = document.querySelector('#topPerformersTable tbody');
  if (tbody) {
    const topStudents = Array.from(studentsMap.values())
      .sort((a, b) => b.percentage - a.percentage)
      .slice(0, 10);
    
    tbody.innerHTML = topStudents.map((s, idx) => {
      const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '';
      return `
      <tr>
        <td><strong>${medal} ${idx + 1}</strong></td>
        <td>${s.roll_number}</td>
        <td>${s.student_name}</td>
        <td>${s.subject}</td>
        <td><strong>${s.total_marks}</strong></td>
        <td><span style="font-weight:700; color:${parseFloat(s.percentage) >= 80 ? colors.success : colors.primary}; font-size: 16px;">${s.percentage}%</span></td>
        <td><span class="grade-badge ${getGradeClass(s.grade)}">${s.grade}</span></td>
      </tr>
    `;
    }).join('');
  }
}

checkAuth();
    </script>
</body>
</html>